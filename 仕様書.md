## 目的

JR旅客営業規則 第3章（普通旅客運賃）に基づき、普通運賃・大人・片道・きっぷでの2駅間の最安運賃と、その経路の運賃内訳（営業キロ・換算キロ・経由駅）をCSV出力するPythonプログラムの実装仕様を定義する。

対象はJR線（在来線・新幹線含むが、本仕様の運賃は「普通旅客運賃」に限定し、特急・指定席・寝台などの料金は対象外）。

## スコープと前提
## 関連ドキュメント

- `アルゴリズム.md`: 探索・計算法の詳細と擬似コード
- `データ仕様.md`: マスタファイルのスキーマ・型・制約
- `条文対応表.md`: 規則条文と仕様項目の対応
- `例・検証ケース.md`: 代表ケースと境界値の期待結果
- `用語集.md`: 用語定義と命名規約


- 対象旅客・券種・片道性: 大人・普通旅客運賃・片道・紙の乗車券（IC運賃は対象外）
- 経路探索対象: JR各社線（私鉄・地下鉄等は含まない）。連絡運輸は考慮しない。
- 出力: 最安となる「きっぷ運賃」と、その運賃を導いた経路情報（営業キロ、換算キロ、経由駅）
- データ前提: 駅・路線・区間キロ・路線区分（幹線/地方交通線）・運賃表・特定都区市内/大都市近郊区間のマスタが整備されていること。

## 参考条文（根拠）

- 第2編 第3章 第2節 普通旅客運賃（例：第77条 幹線内相互発着の大人片道普通旅客運賃）
    - 区分キロ、端数処理（10円単位の四捨五入）等
- 幹線/地方交通線区分と換算キロに関する規定（第77条各号、別表の区分キロ規定）
- 特定都区市内制度の適用要件（第2編 第8章相当。実装上は別マスタで判定）
- 大都市近郊区間の特例（運賃額自体は同じだが注意文言の付与）

注: 正確な条番号・別表番号は最新の公式Webの該当ページを都度参照すること。

## 入出力仕様（CLI/CSV）

- 実行コマンド

```pwsh
python -m jre_fare --from <発駅> --to <着駅> --csv <出力パス> [--via <経由駅,カンマ区切り>] [--max-transfers <数>] [--allow-shinkansen] [--verbose]
```

- 入力
    - `--from`/`--to`: 駅名または駅コード。曖昧一致は行わず、マスタにない場合はエラー。
    - `--via`: 経由駅を固定したい場合に指定（順序拘束）。未指定なら全経路から最安探索。
    - `--max-transfers`: 乗換上限の枝刈り。既定値は実装で適切な小さめ値を設定（例: 6）。
    - `--allow-shinkansen`: 新幹線線区を経路探索に含めるフラグ（普通運賃計算は在来線と同様のキロ計算。料金は別建てで不計）。

- 出力CSVカラム（ヘッダ付き、UTF-8）
    - `from`,`to`,`fare`,`eigyou_km`,`kansan_km`,`calc_km`,`route_stations`
        - `fare`: 最安の片道普通運賃（円、10円単位）
        - `eigyou_km`: 営業キロ合計（幹線+地方、km。1km未満切上済）
        - `kansan_km`: 地方交通線の換算キロ合計（km、小数→最終的に運賃計算キロに切上）
        - `calc_km`: 運賃計算キロ（幹線営業キロ + 地方換算キロ、1km未満切上）
        - `route_stations`: 経由駅を `駅名A→駅名B→...` の文字列で連結

## データモデル（要件）

- 駅マスタ: `station_id`,`name`,`company`(JR会社),`lines`(所属線区ID配列),`zone_flags`(都区市内/近郊区間)
- 線区マスタ: `line_id`,`name`,`type`(`mainline`|`local`|`shinkansen`),`company`
- 区間マスタ: `from_station_id`,`to_station_id`,`line_id`,`distance_km`(営業キロ, 小数可)
- 運賃表マスタ: `table_type`(`mainline`|`local`),`km`,`fare`（1kmごと）
- 換算係数: 地方交通線→換算キロ係数（実装既定値: 1.1）。線区別に上書き可能な設計。
- 特例マスタ: 特定都区市内ゾーン、中心駅、所属駅、近郊区間ゾーン。

## 計算法仕様

1) 経路探索
- グラフ探索で候補経路を列挙。重みは暫定的に「運賃推定コスト（下界）」や「営業キロ」で枝刈り。
- 禁止: 同一駅の再訪（単純路）。最長キロ/乗換上限で打切り。

2) キロ集計と換算
- 経路の各区間を走査し、`K_main`(幹線営業キロ), `K_local`(地方営業キロ) を集計。
- 小数の営業キロは各区間で合算後、トータルで1km未満切上（規則の距離端数処理に準拠）。
- 混在経路: `K_conv = K_local * conv_coeff`（既定1.1）。
- 運賃計算キロ: `K_calc = ceil(K_main + K_conv)`。

3) 運賃表適用
- 幹線のみ: `K_calc = ceil(K_main)` を幹線表に適用。
- 地方のみ: `K_calc = ceil(K_local)` を地方表に適用。
- 混在: 上記 `K_calc` を幹線表に適用。

4) 端数処理
- 規則の四捨五入: 基本運賃×1.10相当の規定等に留意しつつ、普通運賃は10円単位四捨五入（第2節記載）。
- 実装: `fare = round(fare_raw / 10) * 10`。

5) 特例適用
- 特定都区市内制度: 適用条件を満たすとき、中心駅置換で発駅/着駅補正の再計算を行い、安い方を採用。
- 大都市近郊区間: 運賃額は同じ。注意文言「大都市近郊区間内のみのご利用のため、途中下車はできません」を付与。

6) 最安選択
- 候補経路の最終運賃を比較し、最小のものを採用。運賃同額なら営業キロが短い経路、さらに同じなら換算キロが短い経路を優先。なお完全同値の場合のみ、安定化目的で乗換少を最終タイブレークに用いる。

## エッジケース/例外

- 経路が存在しない: エラー終了（終了コード≠0）、メッセージ出力。
- 発着が同一駅: 運賃0円、経由駅は発駅のみ。
- 新幹線経由: `--allow-shinkansen` 指定時のみ探索対象。料金は加算しない（本仕様外）。
- 会社境界: JR各社間の相互発着は通算計算（第77条）。

## 出力例（概念）

```
from,to,fare,eiki_km,kansan_km,calc_km,route_stations
上野,仙台,6050,351,16.5,368,上野→日暮里→…→仙台
```

## 実装指針（Python）

- 構成案
    - `jre_fare/__init__.py`
    - `jre_fare/cli.py`（argparse/typer）
    - `jre_fare/graph.py`（グラフと探索、枝刈り）
    - `jre_fare/fare.py`（キロ集計・換算・運賃表適用・端数処理・特例）
    - `jre_fare/io.py`（CSV出力）
    - `data/*.csv`（マスタ類）

- 主要関数シグネチャ
    - `find_routes(start_id, end_id, *, via_ids=None, max_transfers=6, allow_shinkansen=False) -> list[Route]`
    - `calc_fare_for_route(route: Route, tables: FareTables, conv: dict) -> FareResult`
    - `pick_best(results: list[FareResult]) -> FareResult`

- 検証
    - 単体: 換算キロ、端数処理、表引きの境界値テスト
    - 結合: 混在経路、都区市内適用の有無

## 制約と注意

- 規則の細目（例: 換算キロ係数の線区差、割引特例、連絡運輸）は段階的対応とし、当面は一般規定に限定。
- 最新の規則改定に追随できるよう、マスタ差し替えで追従可能な設計とする。

## 免責

本仕様は公開規則の要点に基づくが、正確性保証は行わない。実運用前に公式最新規則と突合・検証を行うこと。