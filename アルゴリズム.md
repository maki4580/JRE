承知いたしました。JR東日本の旅客営業規則に基づき、「最安運賃」を算出するための運賃計算アルゴリズムについて、実装を目的とした詳細な仕様書を作成します。

---

### JR東日本 運賃計算アルゴリズム仕様書 (Ver 1.0)
関連ドキュメント: `仕様書.md` / `データ仕様.md` / `条文対応表.md` / `例・検証ケース.md` / `用語集.md`


#### 1. 概要

本仕様書は、JR東日本の2駅間における、大人・片道・普通旅客運賃（きっぷ）の最安値を算出するアルゴリズムの仕様を定義するものである。
本アルゴリズムは、物理的に移動可能な全ての経路候補を探索し、それぞれの経路に対してJR東日本の旅客営業規則に準拠した運賃計算を行い、最も安価となる運賃とその経路を特定することを目的とする。

#### 2. 用語定義

| 用語 | 説明 |
| :--- | :--- |
| **ノード (Node)** | 駅を表す。 |
| **エッジ (Edge)** | 駅間を結ぶ路線区間を表す。営業キロ、路線区分（幹線/地方交通線）などの属性を持つ。 |
| **グラフ (Graph)** | ノード（駅）とエッジ（路線）で構成されるJRの路線網全体を表すデータ構造。 |
| **営業キロ** | 運賃計算の基礎となる距離。 |
| **換算キロ** | 地方交通線の営業キロを、幹線の運賃水準に換算するためのキロ程。 |
| **運賃計算キロ** | 幹線と地方交通線をまたがる経路の運賃を計算するために使用するキロ程。（幹線の営業キロ + 地方交通線の換算キロ） |
| **幹線** | JRの路線区分のうち、主要な路線。 |
| **地方交通線** | JRの路線区分のうち、幹線以外の路線。幹線とは異なる運賃体系を持つ。 |

#### 3. 入力・出力

*   **入力 (Input)**
    *   `start_station_code` (string): 出発駅の駅コード
    *   `end_station_code` (string): 到着駅の駅コード

*   **出力 (Output)**
    *   `fare` (integer): 最安運賃（10円単位）
    *   `eigyou_km` (int): 営業キロ合計（1km未満切上後）
    *   `kansan_km` (float): 地方交通線換算キロ合計（小数、最終的に計算キロで切上）
    *   `calc_km` (int): 運賃計算キロ（幹線営業キロ + 換算キロ、1km未満切上）
    *   `route` (object): 最安運賃となる経路情報（経由駅リスト、線区タイプ配列、区間キロ）
    *   `notes` (array of strings): 特記事項（例: 「大都市近郊区間内のみのご利用のため、途中下車はできません」）

#### 4. 前提データ（データベース/マスタデータ）

本アルゴリズムは、以下のデータが事前に整備されていることを前提とする。

1.  **駅マスタ**: 駅コード、駅名、所属路線情報
2.  **路線マスタ**: 路線コード、路線名、**路線区分（幹線/地方交通線）**
3.  **区間（エッジ）マスタ**: 駅Aコード、駅Bコード、路線コード、**営業キロ**
4.  **接続（ノード）マスタ**: 駅コード、乗り換え可能な路線コードのリスト
5.  **運賃マスタ**: 適用区分（幹線/地方交通線）、キロ程範囲(From, To)、運賃額
6.  **特例マスタ**:
    *   **特定都区市内マスタ**: ゾーンコード、ゾーン名、中心駅コード、所属駅コードリスト
    *   **大都市近郊区間マスタ**: ゾーンコード、ゾーン名、所属駅コードリスト

#### 5. アルゴリズム全体の処理フロー

```mermaid
graph TD
    A[処理開始] --> B{入力: 出発駅, 到着駅};
    B --> C[ステップ1: 全経路探索];
    C --> D{経路候補リスト};
    D --> E[ステップ2: 経路ごとの運賃計算 (ループ)];
    E --> F{各経路の運賃リスト};
    F --> G[ステップ3: 最小運賃の選択];
    G --> H{出力: 最安運賃, 経路情報};
    H --> I[処理終了];
```

#### 6. 詳細アルゴリズム

##### ステップ1: 全経路探索

出発駅から到着駅までの全ての有効な経路候補を列挙する。

*   **アルゴリズム**: グラフデータ構造に対し、**深さ優先探索（DFS）** を応用した経路探索アルゴリズムを用いる。
*   **実装**:
    1.  出発駅ノードから探索を開始する。
    2.  再帰的に隣接するノードを探索し、到着駅ノードに到達するまでのパス（駅と路線のシーケンス）を記録する。
    3.  **ループ防止**: 探索中に一度通過した駅を再度通過するような単純なループ経路は除外する。
    4.  **探索打ち切り**: 非現実的な長距離・乗り換え回数の経路を枝刈りするため、最大乗り換え回数や最大営業キロなどの閾値を設けることが望ましい。
    5.  探索の結果、複数の経路候補からなる「経路候補リスト」を生成する。

##### ステップ2: 個別経路の運賃計算 (モジュール)

「経路候補リスト」内の各経路に対し、以下の手順で運賃を算出する。この処理は独立した関数・モジュールとして実装する。

**入力**: 単一の経路情報（駅と路線のシーケンス）
**出力**: 運賃額、特記事項

1.  **キロ程集計**:
    *   経路内の全区間を走査し、以下の値を合計する。
        *   幹線の営業キロ合計 (`K_main`)
        *   地方交通線の営業キロ合計 (`K_local`)
    *   小数の端数処理: 区間ごとの小数は合算後にまとめて処理し、`ceil` で1km未満を切り上げる。

2.  **基本運賃の計算**:
    *   **Case A (幹線のみ)**: `K_local == 0` の場合
        *   `K_total` = `ceil(K_main)`
    *   `Fare_base` = 幹線の運賃マスタ（1km行）から`km==K_total`の運賃を取得。
    *   **Case B (地方交通線のみ)**: `K_main == 0` の場合
        *   `K_total` = `ceil(K_local)`
    *   `Fare_base` = 地方交通線の運賃マスタ（1km行）から`km==K_total`の運賃を取得。
    *   **Case C (幹線・地方交通線 混在)**:
        *   `K_converted` = `K_local * conv_coeff`（既定 1.1。線区別に上書き可能）
        *   `K_calc` = `ceil(K_main + K_converted)`
    *   `Fare_base` = 幹線の運賃マスタ（1km行）から`km==K_calc`の運賃を取得。

3.  **特例の適用（運賃の再評価）**:
    *   **特定都区市内制度の判定と適用**:
        *   **条件**: (出発駅が対象ゾーン内 OR 到着駅が対象ゾーン内) AND 全体の営業キロが201km以上（一部例外あり）。
        *   **適用**: 条件に合致する場合、発着駅をそれぞれの中心駅に置き換えた**仮想的な経路**を作成し、再度 `ステップ2-1` から運賃を計算し直す。この再計算結果を `Fare_special` とする。元の運賃 `Fare_base` とは別に保持する。

4.  **最終運賃額の決定**:
    *   `Fare_temp` = `Fare_special` が存在すれば `Fare_special`、なければ `Fare_base` を採用。

5.  **端数処理**:
    *   第2節の規定に基づき、10円未満を四捨五入。
    *   実装: `Fare_final = round(Fare_temp / 10) * 10`

6.  **特記事項の判定**:
    *   経路上の全駅が「大都市近郊区間マスタ」の同一ゾーン内に含まれるか判定。
    *   含まれる場合、`notes` に「大都市近郊区間内のみのご利用のため、途中下車はできません」を追加。

##### ステップ3: 最小運賃の選択

1.  ステップ2で計算した全ての経路候補の `Fare_final` を比較する。
2.  最小値を持つ運賃を最終的な `fare` とする。
3.  運賃が同額の候補が複数ある場合は、(a) 営業キロが短いもの、(b) それも同じなら換算キロが短いもの、(c) なおも同値の場合のみ乗換回数が少ないもの、の順に優先して1件を選定する。
4.  選定した候補の経路情報を最終的な `route` とし、その経路に付随する `notes` を最終的な `notes` とする。

#### 7. 擬似コード

```python
function calculate_cheapest_fare(start_station, end_station):
    // ステップ1: 全経路探索
    all_routes = find_all_routes(start_station, end_station)

    cheapest_fare = infinity
    best_route = null
    final_notes = []
    
    // ステップ2: 各経路の運賃を計算して比較
    for route in all_routes:
        // 個別の運賃計算モジュールを呼び出す
        result = calculate_fare_for_route(route) 
        
        if result.fare < cheapest_fare:
            cheapest_fare = result.fare
            best_route = route
            final_notes = result.notes
            
    // ステップ3: 最終結果を返す
    return {
        "fare": cheapest_fare,
        "route": best_route,
        "notes": final_notes
    }

function calculate_fare_for_route(route):
    // 2-1. キロ程集計
    k_main = 0
    k_local = 0
    for segment in route.segments:
        if segment.line_type == '幹線':
            k_main += segment.distance
        else:
            k_local += segment.distance

    // 2-2. 基本運賃の計算
    // ... 幹線のみ、地方交通線のみ、混在の場合分けロジック ...
    // fare_base を計算する
    
    // 2-3. 特例の適用
    fare_special = null
    if check_tokutei_tokushinai_condition(route, k_main + k_local):
        // 中心駅に置き換えて再帰的に運賃計算または再計算ロジック
        fare_special = recalculate_for_tokutei_tokushinai(route)

    // 2-4. 最終運賃額の決定
    fare_temp = fare_special if fare_special is not null else fare_base
    
    // 2-5. 端数処理
    fare_final = round(fare_temp / 10) * 10
    
    // 2-6. 特記事項の判定
    notes = []
    if check_daigotoshi_kinkou_condition(route):
        notes.append("大都市近郊区間内のみのご利用のため、途中下車はできません")
        
    return {
        "fare": fare_final,
        "eigyou_km": ceil(k_main + k_local),
        "kansan_km": k_local * conv_coeff if k_main > 0 and k_local > 0 else 0,
        "calc_km": k_calc,
        "notes": notes
    }
```

---
**免責事項:**
本仕様書は、公開されているJR東日本の旅客営業規則に基づいて作成されていますが、規則の解釈や改定により、実際と異なる場合があります。正確な実装のためには、必ず最新の公式な旅客営業規則全文を参照し、必要に応じて専門家にご確認ください。

— 参考: 第2編 第3章 第2節（普通旅客運賃）、幹線/地方交通線・換算キロ・区分キロ・四捨五入の規定。最新条文はJR東日本公式Webの「次へ」で連なる各ページを参照。